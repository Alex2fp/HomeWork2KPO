# HSE Bank — Учёт финансов (Console)

## Описание
Консольное приложение, демонстрирующее управление личными финансами без базы данных. Пользователь может создавать счета, категории, операции, смотреть аналитику по балансам и группировкам, а также импортировать и экспортировать данные в форматах CSV, JSON и YAML.

Приложение построено по принципам SOLID и GRASP, использует DI-контейнер и ряд паттернов GoF для разделения ответственности и повторного использования логики.

## Запуск
```
dotnet run --project src/FinanceApp/FinanceApp.csproj
```

> В среде проверки .NET SDK может быть недоступен. В этом случае достаточно изучить исходный код.

## Архитектура и паттерны
- **Фасад** — `FinanceFacade` инкапсулирует работу с репозиторием, импортом/экспортом и аналитикой.
- **Команда** — `RecalculateBalanceCommand` пересчитывает баланс счёта по операциям, создаётся через `CommandFactory`.
- **Декоратор** — `AnalyticsTimingDecorator` измеряет время выполнения аналитики.
- **Шаблонный метод** — абстрактный `FinanceDataImporter` определяет алгоритм импорта, конкретные форматы реализованы в `CsvFinanceDataImporter`, `JsonFinanceDataImporter`, `YamlFinanceDataImporter`.
- **Посетитель** — `CollectingExportVisitor` и его наследники формируют экспорт в разные форматы.
- **Фабрика** — `FinanceDataImporterFactory` подбирает импортер по формату.

### SOLID & GRASP
- **Single Responsibility** — репозиторий отвечает за хранение, аналитика за расчёты, фасад за сценарии пользователя.
- **Open/Closed** — импортеры и экспортёры легко расширяются новыми форматами.
- **Liskov Substitution** — интерфейсы сервисов допускают взаимозаменяемые реализации.
- **Interface Segregation** — специализированные интерфейсы (`IFinanceFacade`, `IAnalyticsService`, `IFinanceDataExportService`).
- **Dependency Inversion** — зависимости описаны через интерфейсы и внедряются DI-контейнером.
- **High Cohesion / Low Coupling** — каждый модуль сфокусирован на собственной задаче и слабо связан с другими.

## Основные сценарии
1. **Счета** — создание, переименование, удаление. Баланс обновляется автоматически по операциям и может быть пересчитан командой.
2. **Категории** — CRUD, поддерживаются только типы доход и расход.
3. **Операции** — добавление и удаление доходов/расходов, проверка совместимости категорий.
4. **Аналитика** — баланс счёта, суммарные доходы/расходы, разница, группировка по категориям с подсчётом чистого результата.
5. **Импорт/экспорт** — поддержка CSV/JSON/JSONY/YAML, работа по абсолютным путям к файлам. Экспорт сохраняет данные на диск без вывода в консоль.
6. **Диагностика** — время выполнения аналитики измеряется декоратором, но пользовательский интерфейс не выводит метрики.

## Форматы файлов импорта/экспорта

Все форматы используют идентификаторы сущностей (счета, категории, операции), начинающиеся с 0. Формат даты в каждом файле — `dd-MM-yyyy`.

### CSV (`.csv`)

Файл состоит из трёх секций:

```
[Accounts]
<Название счета>,<Валюта>,<Баланс>

[Categories]
<Название категории>,<Тип>

[Operations]
<Название счета>,<Название категории>,<Тип операции>,<Сумма>,<Дата>,<Описание>
```

Типы категорий и операций — `Income` или `Expense`. Баланс и суммы записываются через точку.

### JSON / JSONY (`.json`, `.jsony`)

Структура файла:

```json
{
  "accounts": [ { "id": 0, "name": "Наличные", "currency": "RUB", "balance": 0 } ],
  "categories": [ { "id": 0, "name": "Зарплата", "type": "Income" } ],
  "operations": [
    {
      "id": 0,
      "accountId": 0,
      "categoryId": 0,
      "type": "Income",
      "amount": 1000,
      "date": "01-01-2024",
      "description": "Комментарий"
    }
  ]
}
```

Расширение `.jsony` обрабатывается так же, как `.json`.

### YAML (`.yaml`, `.yml`)

Файл содержит три списка:

```yaml
accounts:
  - name: Наличные
    currency: RUB
    balance: 0
categories:
  - name: Зарплата
    type: Income
operations:
  - account: Наличные
    category: Зарплата
    type: Income
    amount: 1000
    date: 01-01-2024
    description: "Комментарий"
```

Все поля обязательны, кроме `description`.

## Структура проекта
```
src/FinanceApp/
  Domain/                // Доменная модель
  Application/
    Repositories/        // Репозиторий и интерфейсы доступа к данным
    Analytics/           // Сервисы аналитики и декораторы
    Importing/           // Импорт данных (Template Method, Factory)
    Exporting/           // Экспорт данных (Visitor)
    Commands/            // Паттерн Команда
    Facade/              // Фасад приложения
    Data/                // Переносимые модели данных
  Presentation/          // Консольный интерфейс
  Program.cs             // Точка входа и настройка DI
```

## Дополнительно
- В коде предусмотрены базовые проверки инвариантов (положительная сумма операций, уникальность имён и т.д.).
- `Seed` в `Program.cs` добавляет только две категории по умолчанию: `0 | Зарплата | Доход` и `1 | Ресторан | Расход`.
- Идентификаторы счетов, категорий и операций присваиваются последовательно начиная с 0.
- Измерение времени аналитики выполняется, но метрики не выводятся в консоль.
